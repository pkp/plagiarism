(function(t){"use strict";function B(u,o){var s,m,n,E,C;const h=u.id,b=u.sourceSubmissionFileId;if((m=(s=o==null?void 0:o.files)==null?void 0:s[h])!=null&&m.ithenticateId)return(n=o==null?void 0:o.files)==null?void 0:n[h];const p=(E=o==null?void 0:o.files)==null?void 0:E[b];return p&&p.fileId===u.fileId?p:(C=o==null?void 0:o.files)==null?void 0:C[h]}const z=(u,o)=>{const h=u.__vccOpts||u;for(const[b,p]of o)h[b]=p;return h},q={key:0,class:"plagiarism-similarity-score"},D=["href","title"],H=["alt","src"],J={key:1,class:"plagiarism-status"},K={class:"tooltip"},Q={key:0},X={key:1},Y=z({__name:"ithenticateSimilarityScoreCell",props:{file:{type:Object,required:!1},galley:{type:Object,required:!1},fileStageNamespace:{type:String,required:!1}},setup(u){const{useApp:o}=pkp.modules.useApp,h=u,{isOPS:b}=o(),p=b()?pkp.registry.getPiniaStore("galleyManager"):pkp.registry.getPiniaStore(h.fileStageNamespace),s=t.computed(()=>{const m=b()?h.galley.file:h.file;return p!=null&&p.ithenticateStatus?B(m,p.ithenticateStatus||{}):{}});return(m,n)=>{const E=t.resolveComponent("icon"),C=t.resolveComponent("PkpTableCell");return t.openBlock(),t.createBlock(C,null,{default:t.withCtx(()=>{var R,i,l;return[(R=s.value)!=null&&R.ithenticateSimilarityResult?(t.openBlock(),t.createElementBlock("span",q,[t.createElementVNode("a",{href:s.value.ithenticateViewerUrl??"#",target:"_blank",title:m.t("plugins.generic.plagiarism.similarity.action.launch.viewer.title")},[t.createElementVNode("img",{alt:m.t("plugins.generic.plagiarism.similarity.match.title"),src:s.value.ithenticateLogo},null,8,H)],8,D),t.createElementVNode("span",null,t.toDisplayString(s.value.ithenticateSimilarityResult)+" % ",1)])):(i=s.value)!=null&&i.ithenticateId?(t.openBlock(),t.createElementBlock("span",J,[t.createVNode(E,{icon:"InProgress",class:"h-6 w-6"}),t.createElementVNode("span",K,[(l=s.value)!=null&&l.ithenticateSimilarityScheduled?(t.openBlock(),t.createElementBlock("span",X,t.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.reportScheduleCompletd"))+" "+t.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.waitingOnSimilarityScore")),1)):(t.openBlock(),t.createElementBlock("span",Q,t.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.waitingOnReportSchedule")),1))])])):t.createCommentVNode("",!0)]}),_:1})}}},[["__scopeId","data-v-4a9363b4"]]);pkp.registry.registerComponent("ithenticateSimilarityScoreCell",Y);const{useLocalize:Z}=pkp.modules.useLocalize,{useApp:j}=pkp.modules.useApp,{useNotify:ee}=pkp.modules.useNotify,{useCurrentUser:ie}=pkp.modules.useCurrentUser;function L(u,o){if(pkp.registry.getPiniaStore("dashboard").dashboardPage!=="editorialDashboard")return;const{useUrl:b}=pkp.modules.useUrl,{useFetch:p}=pkp.modules.useFetch,{t:s}=Z(),{isOPS:m}=j(),n=u.store,{submission:E,submissionStageId:C}=n.props,{notify:R}=ee(),i=t.ref(null),l=t.ref(null),M=t.ref(600),U=t.computed(()=>{var r,a;return{fileIds:m()?((r=n==null?void 0:n.galleys)==null?void 0:r.map(g=>g.file.id))||[]:((a=n==null?void 0:n.files)==null?void 0:a.map(g=>g.id))||[],submissionId:E.id,stageId:m()?pkp.const.WORKFLOW_STAGE_ID_PRODUCTION:C}}),{apiUrl:W}=b(`submissions/${E.id}/plagiarism/status`),{fetch:f,data:d}=p(W,{method:"POST",body:U});t.watch(U,async e=>{var r;if((r=e==null?void 0:e.fileIds)!=null&&r.length)try{await f(),n.ithenticateStatus=d,d.value&&k(d.value)&&!i.value&&x(e)}catch(a){console.error("Error fetching ithenticateStatus:",a)}},{deep:!0}),m()&&(async()=>{var e,r;try{await f(),n.ithenticateStatus=d,d.value&&((r=(e=U.value)==null?void 0:e.fileIds)!=null&&r.length)&&k(d.value)&&!i.value&&x(U.value)}catch(a){console.error("Error in initial OPS fetch:",a)}})(),n.extender.extendFn("getColumns",(e,r)=>{const a=[...e];return a.splice(a.length-1,0,{header:s("plugins.generic.plagiarism.similarity.match.title"),component:"ithenticateSimilarityScoreCell",props:{fileStageNamespace:o}}),a});function G(e,r,a){return a.ithenticateId?a.ithenticateId&&!a.ithenticateSimilarityScheduled?s("plugins.generic.plagiarism.similarity.action.generateReport.title"):s("plugins.generic.plagiarism.similarity.action.refreshReport.title"):s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.title")}function te(e){return e.ithenticateId?e.ithenticateSimilarityScheduled?s("plugins.generic.plagiarism.similarity.action.refreshReport.confirmation"):s("plugins.generic.plagiarism.similarity.action.generateReport.confirmation"):s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.confirmation")}function le(e){return e.ithenticateId?e.ithenticateSimilarityScheduled?e.ithenticateReportRefreshUrl:e.ithenticateReportScheduleUrl:e.ithenticateUploadUrl}function ne(e,r,a){return e.eulaRequired?!r.ithenticateEulaVersion||!a.ithenticateEulaVersion||r.ithenticateEulaVersion!==a.ithenticateEulaVersion:!1}async function ae(e){const r=le(e),{fetch:a,data:g}=p(r);return await a(),g}function k(e){return e!=null&&e.files?Object.values(e.files).some(r=>r.ithenticateId!==null&&r.ithenticateSimilarityResult===null):!1}n.extender.extendFn("getItemActions",(e,r)=>{var c,y,P;const a=n.props.submission,g=m()?r.galley.file:r.file;if(!m()&&a.stageId!==C)return[...e];if(d.value){const S=B(g,d.value),v=(c=d.value)==null?void 0:c.user,T=(y=d.value)==null?void 0:y.submission,A=(P=d.value)==null?void 0:P.context;if(!S)return[...e];if(!S.ithenticateUploadAllowed)return[...e];const{hasCurrentUserAtLeastOneRole:I}=ie();return I(v.ithenticateActionAllowedRoles)?[...e,{label:G(v,T,S),name:"conductPlagiarismCheck",icon:"Globe",actionFn:V=>{if(!S.ithenticateId&&ne(A,T,v)){const{useLegacyGridUrl:w}=pkp.modules.useLegacyGridUrl,{openLegacyModal:_}=w({component:"plugins.generic.plagiarism.controllers.PlagiarismIthenticateHandler",op:"confirmEula",params:{submissionId:g.submissionId,submissionFileId:g.id,stageId:a.stageId}});_({title:s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.title")},async()=>{await f(),k(d.value)&&!i.value&&x(U.value)});return}const{useModal:N}=pkp.modules.useModal,{openDialog:F}=N();F({title:G(v,T,S),message:te(S),actions:[{label:s("common.yes"),isPrimary:!0,callback:async w=>{var O,$;w();const _=await ae(S);(O=_.value)!=null&&O.content&&R(_.value.content,($=_.value)!=null&&$.status?"success":"warning"),await f(),k(d.value)&&!i.value&&x(U.value)}},{label:s("common.no"),isWarnable:!0,callback:w=>{w()}}]})}}]:[...e]}return[...e]});function x(e){var S;if(i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null),!((S=e==null?void 0:e.fileIds)!=null&&S.length))return;const r=new URLSearchParams({submissionId:e.submissionId,stageId:e.stageId,fileIds:e.fileIds.join(",")}),a=`${W.value}/stream?${r.toString()}`;let g=Date.now(),c=null,y=0;const P=3;try{i.value=new EventSource(a);const v=setTimeout(()=>{Date.now()-g>3e4&&(console.log("No SSE messages received, falling back to polling"),i.value&&(i.value.close(),i.value=null),c=setInterval(async()=>{try{!n.ithenticateStatus.value&&y<P?(await f(),y++):k(d.value)?(await f(),y=0):(clearInterval(c),c=null,y=0)}catch{y++,y>=P&&(clearInterval(c),c=null,y=0)}},1e4))},3e4);i.value.onmessage=T=>{var A;g=Date.now();try{const I=JSON.parse(T.data);if(I.maxDuration){M.value=Number(I.maxDuration),l.value&&(clearTimeout(l.value),l.value=null),l.value=setTimeout(()=>{console.log(`Client-side ${M.value}-second limit reached at:`,new Date().toISOString()),i.value&&(i.value.close(),i.value=null),l.value=null,clearTimeout(v),c&&clearInterval(c),f()},M.value*1e3);return}if(I&&n.ithenticateStatus){const V={...((A=n.ithenticateStatus.value)==null?void 0:A.files)||{}};n.ithenticateStatus.value={...n.ithenticateStatus.value,...I};let N=!1,F=!1;if(I.files&&V&&Object.entries(I.files).forEach(([w,_])=>{const O=V[w];O&&O.ithenticateId!==null&&(O.ithenticateSimilarityResult===null&&_.ithenticateSimilarityResult!==null&&(N=!0),O.ithenticateSimilarityScheduled!=_.ithenticateSimilarityScheduled&&(F=!0))}),F&&R(s("plugins.generic.plagiarism.action.scheduleSimilarityReport.success"),"success"),N&&R(s("plugins.generic.plagiarism.action.refreshSimilarityResult.success"),"success"),(N||F)&&f(),!k(n.ithenticateStatus.value)){i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null),clearTimeout(v),c&&clearInterval(c),f();return}}}catch(I){console.error("Error parsing EventSource data:",I)}},i.value.addEventListener("stream_end",()=>{i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null),clearTimeout(v),c&&clearInterval(c),f()}),i.value.onerror=T=>{i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null),clearTimeout(v),c=setInterval(()=>{k(n.ithenticateStatus.value)?f():clearInterval(c)},1e4),f()},i.value.onopen=()=>{console.log("EventSource connection opened at:",new Date().toISOString())}}catch(v){console.error("Failed to initialize EventSource:",v),c=setInterval(()=>{k(n.ithenticateStatus.value)?f():clearInterval(c)},1e4)}}t.onUnmounted(()=>{i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null)}),window.addEventListener("beforeunload",()=>{i.value&&(i.value.close(),i.value=null),l.value&&(clearTimeout(l.value),l.value=null)})}pkp.registry.storeExtend("fileManager_SUBMISSION_FILES",u=>{L(u,"fileManager_SUBMISSION_FILES")}),pkp.registry.storeExtend("fileManager_EDITOR_REVIEW_FILES",u=>{L(u,"fileManager_EDITOR_REVIEW_FILES")}),pkp.registry.storeExtend("galleyManager",u=>{const{isOPS:o}=j();o()&&L(u,"galleyManager")})})(pkp.modules.vue);
