(function(i){"use strict";function A(c,p){const g=c.id,y=c.sourceSubmissionFileId;if(p?.files?.[g]?.ithenticateId)return p?.files?.[g];const h=p?.files?.[y];return h&&h.fileId===c.fileId?h:p?.files?.[g]}const q=(c,p)=>{const g=c.__vccOpts||c;for(const[y,h]of p)g[y]=h;return g},j={key:0,class:"plagiarism-similarity-score"},W=["href","title"],G=["alt","src"],$={key:1,class:"plagiarism-status"},z={class:"tooltip"},H={key:0},J={key:1},K=q({__name:"ithenticateSimilarityScoreCell",props:{file:{type:Object,required:!1},galley:{type:Object,required:!1},fileStageNamespace:{type:String,required:!1}},setup(c){const{useApp:p}=pkp.modules.useApp,g=c,{isOPS:y}=p(),h=y()?pkp.registry.getPiniaStore("galleyManager"):pkp.registry.getPiniaStore(g.fileStageNamespace),s=i.computed(()=>{const m=y()?g.galley.file:g.file;return h?.ithenticateStatus?A(m,h.ithenticateStatus||{}):{}});return(m,r)=>{const P=i.resolveComponent("icon"),T=i.resolveComponent("PkpTableCell");return i.openBlock(),i.createBlock(T,null,{default:i.withCtx(()=>[s.value?.ithenticateSimilarityResult?(i.openBlock(),i.createElementBlock("span",j,[i.createElementVNode("a",{href:s.value.ithenticateViewerUrl??"#",target:"_blank",title:m.t("plugins.generic.plagiarism.similarity.action.launch.viewer.title")},[i.createElementVNode("img",{alt:m.t("plugins.generic.plagiarism.similarity.match.title"),src:s.value.ithenticateLogo},null,8,G)],8,W),i.createElementVNode("span",null,i.toDisplayString(s.value.ithenticateSimilarityResult)+" % ",1)])):s.value?.ithenticateId?(i.openBlock(),i.createElementBlock("span",$,[i.createVNode(P,{icon:"InProgress",class:"h-6 w-6"}),i.createElementVNode("span",z,[s.value?.ithenticateSimilarityScheduled?(i.openBlock(),i.createElementBlock("span",J,i.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.reportScheduleCompletd"))+" "+i.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.waitingOnSimilarityScore")),1)):(i.openBlock(),i.createElementBlock("span",H,i.toDisplayString(m.t("plugins.generic.plagiarism.file.statusText.waitingOnReportSchedule")),1))])])):i.createCommentVNode("",!0)]),_:1})}}},[["__scopeId","data-v-4a9363b4"]]);pkp.registry.registerComponent("ithenticateSimilarityScoreCell",K);const{useLocalize:Q}=pkp.modules.useLocalize,{useApp:L}=pkp.modules.useApp,{useNotify:X}=pkp.modules.useNotify,{useCurrentUser:Y}=pkp.modules.useCurrentUser;function D(c,p){if(pkp.registry.getPiniaStore("dashboard").dashboardPage!=="editorialDashboard")return;const{useUrl:y}=pkp.modules.useUrl,{useFetch:h}=pkp.modules.useFetch,{t:s}=Q(),{isOPS:m}=L(),r=c.store,{submission:P,submissionStageId:T}=r.props,{notify:F}=X(),t=i.ref(null),a=i.ref(null),x=i.ref(600),E=i.computed(()=>({fileIds:m()?r?.galleys?.map(n=>n.file.id)||[]:r?.files?.map(n=>n.id)||[],submissionId:P.id,stageId:m()?pkp.const.WORKFLOW_STAGE_ID_PRODUCTION:T})),{apiUrl:M}=y(`submissions/${P.id}/plagiarism/status`),{fetch:f,data:u}=h(M,{method:"POST",body:E});i.watch(E,async e=>{if(e?.fileIds?.length)try{await f(),r.ithenticateStatus=u,u.value&&I(u.value)&&!t.value&&O(e)}catch(n){console.error("Error fetching ithenticateStatus:",n)}},{deep:!0}),m()&&(async()=>{try{await f(),r.ithenticateStatus=u,u.value&&E.value?.fileIds?.length&&I(u.value)&&!t.value&&O(E.value)}catch(e){console.error("Error in initial OPS fetch:",e)}})(),r.extender.extendFn("getColumns",(e,n)=>{const o=[...e];return o.splice(o.length-1,0,{header:s("plugins.generic.plagiarism.similarity.match.title"),component:"ithenticateSimilarityScoreCell",props:{fileStageNamespace:p}}),o});function V(e,n,o){return o.ithenticateId?o.ithenticateId&&!o.ithenticateSimilarityScheduled?s("plugins.generic.plagiarism.similarity.action.generateReport.title"):s("plugins.generic.plagiarism.similarity.action.refreshReport.title"):s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.title")}function Z(e){return e.ithenticateId?e.ithenticateSimilarityScheduled?s("plugins.generic.plagiarism.similarity.action.refreshReport.confirmation"):s("plugins.generic.plagiarism.similarity.action.generateReport.confirmation"):s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.confirmation")}function ee(e){return e.ithenticateId?e.ithenticateSimilarityScheduled?e.ithenticateReportRefreshUrl:e.ithenticateReportScheduleUrl:e.ithenticateUploadUrl}function te(e,n,o){return e.eulaRequired?!n.ithenticateEulaVersion||!o.ithenticateEulaVersion||n.ithenticateEulaVersion!==o.ithenticateEulaVersion:!1}async function ie(e){const n=ee(e),{fetch:o,data:b}=h(n);return await o(),b}function I(e){return e?.files?Object.values(e.files).some(n=>n.ithenticateId!==null&&n.ithenticateSimilarityResult===null):!1}r.extender.extendFn("getItemActions",(e,n)=>{const o=r.props.submission,b=m()?n.galley.file:n.file;if(!m()&&o.stageId!==T)return[...e];if(u.value){const l=A(b,u.value),d=u.value?.user,w=u.value?.submission,k=u.value?.context;if(!l)return[...e];if(!l.ithenticateUploadAllowed)return[...e];const{hasCurrentUserAtLeastOneRole:C}=Y();return C(d.ithenticateActionAllowedRoles)?[...e,{label:V(d,w,l),name:"conductPlagiarismCheck",icon:"Globe",actionFn:S=>{if(!l.ithenticateId&&te(k,w,d)){const{useLegacyGridUrl:v}=pkp.modules.useLegacyGridUrl,{openLegacyModal:_}=v({component:"plugins.generic.plagiarism.controllers.PlagiarismIthenticateHandler",op:"confirmEula",params:{submissionId:b.submissionId,submissionFileId:b.id,stageId:o.stageId}});_({title:s("plugins.generic.plagiarism.similarity.action.submitforPlagiarismCheck.title")},async()=>{await f(),I(u.value)&&!t.value&&O(E.value)});return}const{useModal:U}=pkp.modules.useModal,{openDialog:R}=U();R({title:V(d,w,l),message:Z(l),actions:[{label:s("common.yes"),isPrimary:!0,callback:async v=>{v();const _=await ie(l);_.value?.content&&F(_.value.content,_.value?.status?"success":"warning"),await f(),I(u.value)&&!t.value&&O(E.value)}},{label:s("common.no"),isWarnable:!0,callback:v=>{v()}}]})}}]:[...e]}return[...e]});function O(e){if(t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null),!e?.fileIds?.length)return;const n=new URLSearchParams({submissionId:e.submissionId,stageId:e.stageId,fileIds:e.fileIds.join(",")}),o=`${M.value}/stream?${n.toString()}`;let b=Date.now(),l=null,d=0;const w=3;try{t.value=new EventSource(o);const k=setTimeout(()=>{Date.now()-b>3e4&&(console.log("No SSE messages received, falling back to polling"),t.value&&(t.value.close(),t.value=null),l=setInterval(async()=>{try{!r.ithenticateStatus.value&&d<w?(await f(),d++):I(u.value)?(await f(),d=0):(clearInterval(l),l=null,d=0)}catch{d++,d>=w&&(clearInterval(l),l=null,d=0)}},1e4))},3e4);t.value.onmessage=C=>{b=Date.now();try{const S=JSON.parse(C.data);if(S.maxDuration){x.value=Number(S.maxDuration),a.value&&(clearTimeout(a.value),a.value=null),a.value=setTimeout(()=>{console.log(`Client-side ${x.value}-second limit reached at:`,new Date().toISOString()),t.value&&(t.value.close(),t.value=null),a.value=null,clearTimeout(k),l&&clearInterval(l),f()},x.value*1e3);return}if(S&&r.ithenticateStatus){const U={...r.ithenticateStatus.value?.files||{}};r.ithenticateStatus.value={...r.ithenticateStatus.value,...S};let R=!1,v=!1;if(S.files&&U&&Object.entries(S.files).forEach(([_,B])=>{const N=U[_];N&&N.ithenticateId!==null&&(N.ithenticateSimilarityResult===null&&B.ithenticateSimilarityResult!==null&&(R=!0),N.ithenticateSimilarityScheduled!=B.ithenticateSimilarityScheduled&&(v=!0))}),v&&F(s("plugins.generic.plagiarism.action.scheduleSimilarityReport.success"),"success"),R&&F(s("plugins.generic.plagiarism.action.refreshSimilarityResult.success"),"success"),(R||v)&&f(),!I(r.ithenticateStatus.value)){t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null),clearTimeout(k),l&&clearInterval(l),f();return}}}catch(S){console.error("Error parsing EventSource data:",S)}},t.value.addEventListener("stream_end",()=>{t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null),clearTimeout(k),l&&clearInterval(l),f()}),t.value.onerror=C=>{t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null),clearTimeout(k),l=setInterval(()=>{I(r.ithenticateStatus.value)?f():clearInterval(l)},1e4),f()},t.value.onopen=()=>{console.log("EventSource connection opened at:",new Date().toISOString())}}catch(k){console.error("Failed to initialize EventSource:",k),l=setInterval(()=>{I(r.ithenticateStatus.value)?f():clearInterval(l)},1e4)}}i.onUnmounted(()=>{t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null)}),window.addEventListener("beforeunload",()=>{t.value&&(t.value.close(),t.value=null),a.value&&(clearTimeout(a.value),a.value=null)})}pkp.registry.storeExtend("fileManager_SUBMISSION_FILES",c=>{D(c,"fileManager_SUBMISSION_FILES")}),pkp.registry.storeExtend("fileManager_EDITOR_REVIEW_FILES",c=>{D(c,"fileManager_EDITOR_REVIEW_FILES")}),pkp.registry.storeExtend("galleyManager",c=>{const{isOPS:p}=L();p()&&D(c,"galleyManager")})})(pkp.modules.vue);
